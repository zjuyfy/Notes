> **定义**1（离散化控制体）
>
> 我们将一个矩形问题域 $\omega$ 离散成一组矩形网格控制体格。每个==控制体==用一个指标组 $\vec i\in\mathbb Z^D$ 表示：[^关于标记]
> $$
> \mathcal C_\vec i=[\vec x_O+\vec i h,\,\vec x_O+(\vec i+\vec 1)h]
> $$
> 其在第 $d$ 个维度下的==控制面==为
> $$
> \mathcal F_{\vec i+\frac12\vec {e}^d}=[\vec x_O+(\vec i+\vec{e}^d)h,\,\vec x_O+(\vec i+\vec 1)h]
> $$
> 其中，$\vec x_O$ 是坐标系的固定原点，$h$ 是统一的网格间距，$\vec 1\in\mathbb Z^D$ 所有分量均为1，$\vec {e}^d\in\mathbb Z^D$ 的第 $d$ 个分量为1、其余为0。（类似于第 $d$ 个维度的单位矢量）

> **例子**（边界条件的可解性条件）
>
> 方程
> $$
> \begin{cases}
> \Delta u=f,&x\in D\\
> \frac{\part u}{\part n}=\phi,&x\in\part D
> \end{cases}
> $$
> 若不满足
> $$
> \oint_D\phi dx=\int_D fdx
> $$
> 则两个方程自相矛盾，方程不可解。





----

# FV（有限体积法）平均

> **定义**2（控制体平均）
>
> 函数 $\phi:\mathbb R^D\rightarrow\mathbb R$ 在控制体 $\vec i$ 上的==控制体平均==定义为 [^因此全空间的积分等于平均之和]
> $$
> \left<\phi\right>_\vec i=\frac1{h^D}\int_{\mathcal C_\vec i}\phi(\vec x)d\vec x
> $$
>
> > **定义**3（面平均）
> >
> > 函数 $\phi:\mathbb R^D\rightarrow\mathbb R$ 在面 $\vec i+\frac12\vec e^d$ 上的==面平均==定义为
> > $$
> > \left<\phi\right>_{\vec i+\frac12\vec e^d}=\frac1{h^{D-1}}\int_{\mathcal F_{\vec i+\frac12\vec e^d}}\phi(\vec x)d\vec x
> > $$

> **定理**1（点值算平均值的近似）
> $$
> \begin{aligned}
> \langle\phi\rangle_{\vec{i}} &=\phi_{\vec{i}}+\left.\frac{h^{2}}{24} \sum_{d=1}^{\mathrm{D}} \frac{\partial^{2} \phi(\vec{x})}{\partial x_{d}^{2}}\right|_{\vec{i}}+O\left(h^{4}\right) \\
> \langle\phi\rangle_{\vec{i}+\frac{1}{2} \vec{e}^{d}} &=\phi_{\vec{i}+\frac{1}{2} \vec{e}^{d}}+\left.\frac{h^{2}}{24} \sum_{d^{\prime} \neq d} \frac{\partial^{2} \phi(\vec{x})}{\partial x_{d^{\prime}}^{2}}\right|_{\vec{i}+\frac{1}{2} \vec{e}^{d}}+O\left(h^{4}\right)
> \end{aligned}
> $$

> <a name="定理2"> </a>**定理**2（控制体平均算面平均的近似）
> $$
> \langle\phi\rangle_{\vec{i}+\frac{1}{2} \vec{e}^{d}} =\frac7{12}\left(\left<\phi\right>_{\vec i}+\left<\phi\right>_{\vec i+\vec e^d}\right)-\frac1{12}\left(\left<\phi\right>_{\vec i-\vec e^d}+\left<\phi\right>_{\vec i+2\vec e^d}\right)+O(h^4)\\
> \langle\frac{\part\phi}{\part x_d}\rangle_{\vec{i}+\frac{1}{2} \vec{e}^{d}} =\frac{15}{12h}\left(\left<\phi\right>_{\vec i+\vec e^d}-\left<\phi\right>_{\vec i}\right)-\frac1{12h}\left(\left<\phi\right>_{\vec i+2\vec e^d}-\left<\phi\right>_{\vec i-\vec e^d}\right)+O(h^4)
> $$
>





----

# 4阶精确的离散算子

> **定义**4（矢量微分的4阶精确离散版本）
>
> ==离散梯度算子==$G_d$：
> $$
> \operatorname G_d\,\left<\phi\right>_{\vec i}=\frac1{12h}\left(-\left<\phi\right>_{\vec i+2\vec e^d}+8\left<\phi\right>_{\vec i+\vec e^d}-8\left<\phi\right>_{\vec i-\vec e^d}+\left<\phi\right>_{\vec i-2\vec e^d}\right)
> $$
> ==离散散度==$D$：
> $$
> \operatorname D\,\left<\vec u\right>_{\vec i}=\frac1{12h}\sum_d\left(-\left<u_d\right>_{\vec i+2\vec e^d}+8\left<u_d\right>_{\vec i+\vec e^d}-8\left<u_d\right>_{\vec i-\vec e^d}+\left<u_d\right>_{\vec i-2\vec e^d}\right)
> $$
> ==离散拉普拉斯算子==$L$:
> $$
> \operatorname L\,\left<\phi\right>_{\vec i}=\frac1{12h^2}\sum_d\left(-\left<\phi\right>_{\vec i+2\vec e^d}+16\left<\phi\right>_{\vec i+\vec e^d}-30\left<\phi\right>_\vec i+16\left<\phi\right>_{\vec i-\vec e^d}-\left<\phi\right>_{\vec i-2\vec e^d}\right)
> $$
> ==张量散度算子==：
> $$
> \mathbf{D}\langle\mathbf{u} \mathbf{u}\rangle_{\mathbf{i}}=\frac{1}{h} \sum_{d}\left(\mathbf{F}\left\langle u_{d}, \mathbf{u}\right\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}-\mathbf{F}\left\langle u_{d}, \mathbf{u}\right\rangle_{\mathbf{i}-\frac{1}{2} \mathbf{e}^{d}}\right),
> $$
> 其中两个函数内积的离散面平均
> $$
> \begin{aligned}
> \mathbf{F}\langle\phi, \psi\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}} &=\langle\phi\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}\langle\psi\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}} \\
> &+\frac{h^{2}}{12} \sum_{d^{\prime} \neq d}\left(\mathbf{G}_{d^{\prime}}^{\perp} \phi\right)_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}\left(\mathbf{G}_{d^{\prime}}^{\perp} \psi\right)_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}},
> \end{aligned}
> $$
> 其中 $\vec{G}_{d^{\prime}}^{\perp}$ 是横向（垂直方向）的离散散度,
> $$
> \left(\mathbf{G}_{d^{\prime}}^{\perp} \phi\right)_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}=\frac{1}{2 h}\left(\langle\phi\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}+\mathbf{e}^{d^{\prime}}}-\langle\phi\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}-\mathbf{e}^{d^{\prime}}}\right) .
> $$
>
> > **性质**
> >
> > 这些公式是四阶精确的：
> > $$
> > \operatorname {O'}\left<a\right>_\vec i=\frac 1{h^D}\int_{\mathcal C_\vec i}[\operatorname O(a)] +O(h^4)\\
> > \vec{F}\langle\phi, \psi\rangle_{\vec{i}+\frac{1}{2} \vec{e}^{d}}=\frac1{h^{D-1}}\int_{\mathcal F_{\vec{i}+\frac{1}{2} \vec{e}^{d}}}(\phi\psi)+O(h^4)
> > $$
> > 其中，$\operatorname O'$ 为离散算子，$\operatorname O$ 为对应普通算子。

----

# 伪控制体

> **定义**5（伪控制体）
>
> 是在非周期区域边界附近用来方便计算FV或FD的而假设的控制体。

> **算法**1（离散对流）
>
> 计算 $\operatorname D\left<\vec u\vec u\right>$ 的步骤：
>
> 1. 通过以下公式算伪控制体的平均：(其中g为狄利克雷边界条件（第一类边界条件）)
>    $$
>    \begin{aligned}
>    \langle\vec u\rangle_{\mathbf{i}+\mathbf{e}^{d}}=& \frac{1}{3}\left(-13\langle\vec u\rangle_{\mathbf{i}}+5\langle\vec u\rangle_{\mathbf{i}-\mathbf{e}^{d}}-\langle\vec u\rangle_{\mathbf{i}-2 \mathbf{e}^{d}}\right) +4\langle g\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}+O\left(h^{4}\right) ; \\
>    \langle\vec u\rangle_{\mathbf{i}+2 \mathbf{e}^{d}}=& \frac{1}{3}\left(-70\langle\vec u\rangle_{\mathbf{i}}+32\langle\vec u\rangle_{\mathbf{i}-\mathbf{e}^{d}}-7\langle\vec u\rangle_{\mathbf{i}-2 \mathbf{e}^{d}}\right) +12\langle g\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}+O\left(h^{4}\right) .
>    \end{aligned}
>    $$
>
> 1. 通过[定理2](#定理2)算各个方向的面平均 $\left<u_d\right>_{\vec i\pm\frac12\vec e^d}$.
>
> 1. 通过[定理2](#定理2)算各个方向的面平均 $\left<\vec u\right>_{\vec i\pm\frac12\vec e^d}$.
>
> 1. 通过这些平均计算离散的张量散度算子。





----

# 有限体积法求解BVPs

> **算法**2（四阶精度FV法求解BVPs）
>
> 求解纽曼 BVP:
> $$
> \Delta \phi=\nabla \cdot \vec u\\
> \frac{\part \phi}{\part \vec n}=\vec n\cdot \vec u
> $$
>
> 1. 将 $\vec u$ 和 $\phi$ 平滑延拓（无边界条件的平滑延拓）（由于会抵消掉，所以边界直接设成0）
>    $$
>    \begin{aligned}
>    \langle\vec u\rangle_{\mathbf{i}+\mathbf{e}^{d}}=& 5\langle\vec u\rangle_{\mathbf{i}}-10\langle\vec u\rangle_{\mathbf{i}-\mathbf{e}^{d}}+10\langle\vec u\rangle_{\mathbf{i}-2 \mathbf{e}^{d}}-5\langle\vec u\rangle_{\mathbf{i}-3 \mathbf{e}^{d}} \\
>    &+\langle\vec u\rangle_{\mathbf{i}-4 \mathbf{e}^{d}}+O\left(h^{5}\right) ;
>    \end{aligned}
>    $$
>
>    $$
>    \begin{aligned}
>    \langle\vec u\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}=& \frac{1}{60}\left(137\langle\vec u\rangle_{\mathbf{i}}-163\langle\vec u\rangle_{\mathbf{i}-\mathbf{e}^{d}}+137\langle\vec u\rangle_{\mathbf{i}-2 \mathbf{e}^{d}}\right.\\
>    &\left.-63\langle\vec u\rangle_{\mathbf{i}-3 \mathbf{e}^{d}}+12\langle\vec u\rangle_{\mathbf{i}-4 \mathbf{e}^{d}}\right)+O\left(h^{5}\right) .
>    \end{aligned}
>    $$
>
>    
>
> 1. 通过[定理2](#定理2)算各个方向的面平均 $\left<u_d\right>_{\vec i\pm\frac12\vec e^d}$.
>
> 1. 把边界的面平均设成0
>
> 1. 对每个内部单元格的表面平均法向速度求和。
>
> 
>
> 注意：若要算梯度，则需要通过以下公式算伪控制体的平均（纽曼边界条件的延拓）
> $$
> \begin{aligned}
> \langle\psi\rangle_{\mathbf{i}+\mathbf{e}^{d}}=& \frac{1}{10}\left(5\langle\psi\rangle_{\mathbf{i}}+9\langle\psi\rangle_{\mathbf{i}-\mathbf{e}^{d}}-5\langle\psi\rangle_{\mathbf{i}-2 \mathbf{e}^{d}}+\langle\psi\rangle_{\mathbf{i}-3 \mathbf{e}^{d}}\right) \\
> &+\frac{6}{5} h\left\langle\frac{\partial \psi}{\partial n}\right\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}+O\left(h^{5}\right), \\
> \langle\psi\rangle_{\mathbf{i}+2 \mathbf{e}^{d}}=& \frac{1}{10}\left(-75\langle\psi\rangle_{\mathbf{i}}+145\langle\psi\rangle_{\mathbf{i}-\mathbf{e}^{d}}-75\langle\psi\rangle_{\mathbf{i}-2 \mathbf{e}^{d}}\right.\\
> &\left.+15\langle\psi\rangle_{\mathbf{i}-3 \mathbf{e}^{d}}\right)+6 h\left\langle\frac{\partial \psi}{\partial n}\right\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}+O\left(h^{5}\right),
> \end{aligned}
> $$
> 



----

# 对流扩散方程的FV-MOL算法

> **定义**6（对流扩散方程）
>
> ==对流扩散方程==是满足以下形式的偏微分方程：
> $$
> \frac{\part \phi}{\part t}=-\nabla\cdot(\vec u \phi)+\nu\Delta\phi+f
> $$
> 其中，$\vec u$ ，$\nu$ 和 $f$ 已知。
>
> > **算法**
> >
> > 对每个控制体取平均，得到ODE：
> > $$
> > \frac{d\left< \phi\right>_\vec i}{\part t}=-L_{对流}( \left< \phi\right>,t)_\vec i+L_{扩散}(\left< \phi\right>)_\vec i+\left< f\right>_\vec i
> > $$
> > 其中
> > $$
> > \begin{aligned}
> > L_{\mathrm{对流}}(\langle\phi\rangle, t)_{\mathbf{i}} &=-\frac{1}{h} \sum_{d=1}^{D}\left(\left\langle u_{d} \phi\right\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}-\left\langle u_{d} \phi\right\rangle_{\mathbf{i}-\frac{1}{2} \mathbf{e}^{d}}\right) \\
> > L_{\mathrm{扩散}}(\langle\phi\rangle)_{\mathbf{i}} &=\nu\langle\Delta \phi\rangle_{\mathbf{i}} \\
> > &=\frac{\nu}{h} \sum_{d=1}^{D}\left(\left\langle\frac{\partial \phi}{\partial x_{d}}\right\rangle_{\mathbf{i}+\frac{1}{2} \mathbf{e}^{d}}-\left\langle\frac{\partial \phi}{\partial x_{d}}\right\rangle_{\mathbf{i}-\frac{1}{2} \mathbf{e}^{d}}\right)
> > \end{aligned}
> > $$

> **算法**3（龙格库塔法）
>
> ERK-ESDIRK IMplicit-EXplicit(IMEX)龙格库塔法求解ODE[^\[E\]代表显式部分，\[I\]代表隐式部分]。
> $$
> \frac{d \phi}{d t}=\vec X^{[E]}(\phi,t)+\vec X^{[I]}(\phi)
> $$
> 的步骤如下
> $$
> \begin{gathered}
> \phi^{(1)}=\phi^{n} \approx \phi\left(t^{n}\right) \\
> \forall s=2,3, \ldots, n_{\mathrm{s}}, \,\,\,
> \left(I-k \gamma \mathbf{X}^{[\mathrm{I}]}\right) \phi^{(s)}=\phi^{n}+k \sum_{j=1}^{s-1} a_{s, j}^{[E]} \mathbf{X}^{[\mathrm{E}]}\left(\phi^{(j)}, t^{(j)}\right) \\
> +k \sum_{j=1}^{s-1} a_{s, j}^{[I]} \mathbf{X}^{[\mathrm{I}]} \phi^{(j)} \\
> \phi^{n+1}=\phi^{n}+k \sum_{s=1}^{n_{\mathrm{s}}} b_{s}^{[E]} \mathbf{X}^{[\mathrm{E}]}\left(\phi^{(s)}, t^{(s)}\right) \\
> +k \sum_{s=1}^{n_{\mathrm{s}}} b_{s}^{[I]} \mathbf{X}^{[\mathrm{I}]} \phi^{(s)}
> \end{gathered}
> $$
> 



----

[^关于标记]: 这个笔记用了矢量标志来区分指标组和数。
[^因此全空间的积分等于平均之和]: $\int_\Omega fdx=h^D\sum_{\vec i}\left<f\right>_\vec i$
[^\[E\]代表显式部分，\[I\]代表隐式部分]: 对于刚性的部分需要用隐式的方法计算，不然会爆炸；而对于非刚性的部分，用显式即可。拿对流扩散方程来举例，平流部分（即 $L_{对流}$ 和 $f$）非刚性，属于 $\vec X^{[E]}(\phi,t)$；而扩散部分（即 $L_{扩散}$）刚性，属于 $\vec X^{[I]}(\phi)$